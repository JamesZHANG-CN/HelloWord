<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>微信支付PHP开发对接18讲——01: Formatter 从格式化参数说起 - TheNorthMemory</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="James" /><meta name="description" content="SDK目标是优先`APIv3`版，当然也需要考虑当下，`APIv2`还在并行运行。两者之间有共性也有特性，把共性部分抽象出来，当属`格式化`参数部分。`随机字符串`首当其冲，那就从这个函数实现开始吧。" /><meta name="keywords" content="微信支付, WeChatPay PHP SDK, GuzzleHttp, PHPStan Level8" />



<meta name="google-site-verification" content="ilxnhUCMJcotuhg8OoMLLLBfiX8UKrXg4ScYRrSErRs" />


<meta name="generator" content="Hugo 0.55.6 with even 4.0.0" />


<link rel="canonical" href="/post/18-points-of-the-wechatpay-php-openapi-sdk-section01/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<style>.container{min-height: 98vh}.header .logo-wrapper .logo{font-size:36px;}</style>

<meta property="og:title" content="微信支付PHP开发对接18讲——01: Formatter 从格式化参数说起" />
<meta property="og:description" content="SDK目标是优先`APIv3`版，当然也需要考虑当下，`APIv2`还在并行运行。两者之间有共性也有特性，把共性部分抽象出来，当属`格式化`参数部分。`随机字符串`首当其冲，那就从这个函数实现开始吧。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/18-points-of-the-wechatpay-php-openapi-sdk-section01/" />
<meta property="article:published_time" content="2021-06-27T17:00:11&#43;08:00"/>
<meta property="article:modified_time" content="2021-06-29T11:59:20&#43;08:00"/>

<meta itemprop="name" content="微信支付PHP开发对接18讲——01: Formatter 从格式化参数说起">
<meta itemprop="description" content="SDK目标是优先`APIv3`版，当然也需要考虑当下，`APIv2`还在并行运行。两者之间有共性也有特性，把共性部分抽象出来，当属`格式化`参数部分。`随机字符串`首当其冲，那就从这个函数实现开始吧。">


<meta itemprop="datePublished" content="2021-06-27T17:00:11&#43;08:00" />
<meta itemprop="dateModified" content="2021-06-29T11:59:20&#43;08:00" />
<meta itemprop="wordCount" content="5347">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="微信支付PHP开发对接18讲——01: Formatter 从格式化参数说起"/>
<meta name="twitter:description" content="SDK目标是优先`APIv3`版，当然也需要考虑当下，`APIv2`还在并行运行。两者之间有共性也有特性，把共性部分抽象出来，当属`格式化`参数部分。`随机字符串`首当其冲，那就从这个函数实现开始吧。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">TheNorthMemory</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">Posts</li>
      </a><a href="https://thenorthmemory.github.io/wechat-swagger/">
        <li class="mobile-menu-item">WeDocs</li>
      </a><a href="https://thenorthmemory.github.io/wechatpay-openapi/">
        <li class="mobile-menu-item">Wechatpay</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">TheNorthMemory</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">Posts</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://thenorthmemory.github.io/wechat-swagger/">WeDocs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://thenorthmemory.github.io/wechatpay-openapi/">Wechatpay</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">微信支付PHP开发对接18讲——01: Formatter 从格式化参数说起</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-06-27 </span>
        <div class="post-category">
            <a href="/categories/php/"> php </a>
            <a href="/categories/wechat/"> wechat </a>
            </div>
        
      </div>
    </header>

    
    <div class="post-content">
      

<p>SDK目标是优先<code>APIv3</code>版，当然也需要考虑当下，<code>APIv2</code>还在并行运行。两者之间有共性也有特性，把共性部分抽象出来，当属<code>格式化</code>参数部分。<code>随机字符串</code>首当其冲，那就从这个函数实现开始吧。</p>

<h2 id="formatter-nonce-随机字符串产生器">Formatter::nonce 随机字符串产生器</h2>

<p>本博发布之日，这个函数已经迭代了一个版本，并且加入了测试用例覆盖，最终形态如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Generate a random ASCII string aka `nonce`, similar as `random_bytes`.
</span><span class="sd"> *
</span><span class="sd"> * @param int $size - Nonce string length, default is 32.
</span><span class="sd"> *
</span><span class="sd"> * @return string - base62 random string.
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">nonce</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">array_reduce</span><span class="p">(</span><span class="nx">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$size</span><span class="p">),</span> <span class="k">static</span> <span class="k">function</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$char</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$char</span> <span class="o">.=</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">[</span><span class="nx">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">)];</span>
    <span class="p">},</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>本来是可以一行显示的，为了阅读起来方便，特意做了格式化，这个函数使用了PHP内置的三个函数<code>array_reduce</code>, <code>range</code> 及 <code>mt_rand</code>，并且使用了 <code>Closure</code> <code>Static Anonymous Functions</code>。
此函数的设计思路是：根据入参<code>$size</code>，先构建一个堆栈，然后从 <code>Base62</code> 字符串内随机取个数，填充堆栈并合并返回。</p>

<p>上一版是这么实现的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">const</span> <span class="no">BASE62_CHARS</span> <span class="o">=</span> <span class="s1">&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">nonce</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;#0#&#39;</span><span class="p">,</span> <span class="k">static</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">BASE62_CHARS</span><span class="p">[</span><span class="nx">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">)];</span>
    <span class="p">},</span> <span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="nv">$size</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>使用了 <code>preg_replace_callback</code> <code>rand</code> 及 <code>str_repeat</code> 三个内置函数，同样的设计思路，不过有个缺陷，即 <code>$size</code> 型参必须大于0，这个是受限 <code>str_repeat</code> 型参要求。</p>

<p>两个函数其实都备注有与PHP内置的 <code>random_bytes</code> 函数相似，而 <code>random_bytes</code> 也存在型参 <code>$size</code> 必须大于0的要求，其返回值是 <code>Base36</code> 的。</p>

<p>最终选择 <code>array_reduce+range+mt_rand</code> 的组合，这里是做了性能测试的，测试代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// file: cli.php, run: php -f cli.php
<span class="cp">&lt;?php</span>
<span class="k">const</span> <span class="no">BASE62_CHARS</span> <span class="o">=</span> <span class="s1">&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">;</span>

<span class="nv">$start</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$a</span> <span class="o">.=</span> <span class="nx">BASE62_CHARS</span><span class="p">[</span><span class="nx">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">)];</span>
<span class="p">}</span>
<span class="nx">printf</span><span class="p">(</span>
    <span class="s1">&#39;[%30s] Time: %.7f s  %-32.32s %s&#39;</span><span class="p">,</span> <span class="s1">&#39;preg_replace_callback&#39;</span><span class="p">,</span>
    <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">,</span> <span class="nv">$a</span><span class="p">,</span> <span class="nx">PHP_EOL</span>
<span class="p">);</span>

<span class="nv">$start</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;#0#&#39;</span><span class="p">,</span> <span class="k">static</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">BASE62_CHARS</span><span class="p">[</span><span class="nx">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">)];</span>
<span class="p">},</span> <span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">));</span>
<span class="nx">printf</span><span class="p">(</span>
    <span class="s1">&#39;[%30s] Time: %.7f s  %-32.32s %s&#39;</span><span class="p">,</span> <span class="s1">&#39;preg_replace_callback&#39;</span><span class="p">,</span>
    <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">,</span> <span class="nv">$a</span><span class="p">,</span> <span class="nx">PHP_EOL</span>
<span class="p">);</span>

<span class="nv">$start</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nx">array_reduce</span><span class="p">(</span><span class="nx">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="k">static</span> <span class="k">function</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$c</span> <span class="o">.=</span> <span class="s1">&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">[</span><span class="nx">random_int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">)];</span>
<span class="p">},</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="nx">printf</span><span class="p">(</span>
    <span class="s1">&#39;[%30s] Time: %.7f s  %-32.32s %s&#39;</span><span class="p">,</span> <span class="s1">&#39;preg_replace_callback&#39;</span><span class="p">,</span>
    <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">,</span> <span class="nv">$a</span><span class="p">,</span> <span class="nx">PHP_EOL</span>
<span class="p">);</span>

<span class="nv">$start</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nx">array_reduce</span><span class="p">(</span><span class="nx">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="k">static</span> <span class="k">function</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$c</span> <span class="o">.=</span> <span class="s1">&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">[</span><span class="nx">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">)];</span>
<span class="p">},</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="nx">printf</span><span class="p">(</span>
    <span class="s1">&#39;[%30s] Time: %.7f s  %-32.32s %s&#39;</span><span class="p">,</span> <span class="s1">&#39;preg_replace_callback&#39;</span><span class="p">,</span>
    <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">,</span> <span class="nv">$a</span><span class="p">,</span> <span class="nx">PHP_EOL</span>
<span class="p">);</span>

<span class="nv">$start</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">bin2hex</span><span class="p">(</span><span class="nx">random_bytes</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
<span class="nx">printf</span><span class="p">(</span>
    <span class="s1">&#39;[%30s] Time: %.7f s  %-32.32s %s&#39;</span><span class="p">,</span> <span class="s1">&#39;preg_replace_callback&#39;</span><span class="p">,</span>
    <span class="nx">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">,</span> <span class="nv">$a</span><span class="p">,</span> <span class="nx">PHP_EOL</span>
<span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div>
<p>跑上四圈的结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></pre></td>
<td class="lntd">
<pre class="chroma">[                      for loop] Time: 0.0004230 s  twqdlCDCyMknrFMJEjPfl94SdFK2a2Km
[         preg_replace_callback] Time: 0.0035770 s  aTb7yrpFVitQju7sKAgofTuiSsiw1Top
[       array_reduce/random_int] Time: 0.0001869 s  9IkLR7HEryOy8zlzuxpVIBpttpprlNib
[          array_reduce/mt_rand] Time: 0.0000098 s  7j2F2stRXiHvAxQ4j2IhplHXCHMGtl9j
[   substr/bin2hex/random_bytes] Time: 0.0000100 s  e6e33fd212b3083bfc4ebb29a13710b1


[                      for loop] Time: 0.0000420 s  UppY2CoJOVSmHE0EkynhyOeqaWdvSGJ5
[         preg_replace_callback] Time: 0.0002630 s  s64pxnpKALGq16HxnbCbKh0NGgRq8Ou2
[       array_reduce/random_int] Time: 0.0001841 s  7yYaGsWoBudf5PKlz2OkdodGrN05OkQo
[          array_reduce/mt_rand] Time: 0.0000188 s  0ruErA844vf9CifmfhEiyjoUVcbgv3yy
[   substr/bin2hex/random_bytes] Time: 0.0000091 s  db57e8c90751d00b76da5d553f54c950


[                      for loop] Time: 0.0000441 s  0hZgmb4EeYuL14FDd0UIkbjiNyjGjZxy
[         preg_replace_callback] Time: 0.0002651 s  BMoSsbN2N7ObEDmqpgtTKKtGdMiUuV4U
[       array_reduce/random_int] Time: 0.0001869 s  7cGZKBUGiZL6v594o5k6wtQTmm5I7IYq
[          array_reduce/mt_rand] Time: 0.0000200 s  leXlVr5aJ8zmhbn9kk27D3bpy4FJ6Mhy
[   substr/bin2hex/random_bytes] Time: 0.0000100 s  7c9de4e1ee533aa3c9ddecf78667afaf


[                      for loop] Time: 0.0000479 s  OpqudO593AKmRROllDX8h0tjuBzLXPQZ
[         preg_replace_callback] Time: 0.0002871 s  oXoJEBRt0Qpy5jXUNDnAapblbXhpBFI3
[       array_reduce/random_int] Time: 0.0002170 s  SPdIjbbiI3wKLrMCnAiurpBdnxeJsip6
[          array_reduce/mt_rand] Time: 0.0000169 s  bKygHiTtIj6LsnmWxRKXTtSpr1oIdkBJ
[   substr/bin2hex/random_bytes] Time: 0.0000169 s  f8c4105678ba0e97f41fbb9197332f28</pre></td></tr></table>
</div>
</div>
<p>其中 <code>preg_replace_callback</code> 组合是最慢的， <code>array_reduce/mt_rand</code> 组合与最快的 <code>random_bytes</code> 很接近。</p>

<p><code>array_reduce/mt_rand</code> 接受的入参可以是负数，也可以是正数，从严谨性上来取舍，遂选择了这个组合。
<a href="https://github.com/TheNorthMemory/wechatpay-php/blob/5fb1c64a154cc63bbff730e59c0632c0f6e45043/tests/FormatterTest.php">测试用例</a>如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">nonceRulesProvider</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">&#39;default $size=32&#39;</span>       <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span>  <span class="s1">&#39;/[a-zA-Z0-9]{32}/&#39;</span><span class="p">],</span>
        <span class="s1">&#39;half-default $size=16&#39;</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span>  <span class="s1">&#39;/[a-zA-Z0-9]{16}/&#39;</span><span class="p">],</span>
        <span class="s1">&#39;hundred $size=100&#39;</span>      <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;/[a-zA-Z0-9]{100}/&#39;</span><span class="p">],</span>
        <span class="s1">&#39;one $size=1&#39;</span>            <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span>   <span class="s1">&#39;/[a-zA-Z0-9]{1}/&#39;</span><span class="p">],</span>
        <span class="s1">&#39;zero $size=0&#39;</span>           <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="s1">&#39;/[a-zA-Z0-9]{2}/&#39;</span><span class="p">],</span>
        <span class="s1">&#39;negative $size=-1&#39;</span>      <span class="o">=&gt;</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="s1">&#39;/[a-zA-Z0-9]{3}/&#39;</span><span class="p">],</span>
        <span class="s1">&#39;negative $size=-16&#39;</span>     <span class="o">=&gt;</span> <span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;/[a-zA-Z0-9]{18}/&#39;</span><span class="p">],</span>
        <span class="s1">&#39;negative $size=-32&#39;</span>     <span class="o">=&gt;</span> <span class="p">[</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;/[a-zA-Z0-9]{34}/&#39;</span><span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>
<span class="sd">/**
</span><span class="sd"> * @dataProvider nonceRulesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testNonce</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$size</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$pattern</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$nonce</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">nonce</span><span class="p">(</span><span class="nv">$size</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsString</span><span class="p">(</span><span class="nv">$nonce</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertTrue</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$nonce</span><span class="p">)</span> <span class="o">===</span> <span class="p">(</span><span class="nv">$size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nv">$size</span> <span class="o">:</span> <span class="nx">abs</span><span class="p">(</span><span class="nv">$size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;assertMatchesRegularExpression&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMatchesRegularExpression</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$nonce</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertRegExp</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$nonce</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>适应性上堪称完美。</p>

<p><strong>一个重要提示</strong>： 按照PHP手册上提示，<code>mt_rand</code>是密码学不安全的函数，这里也做一并提示 <code>Formatter::nonce()</code> 也是密码学不安全实现。本类库在使用时，仅当<code>salt</code>（盐）使用，扩展使用时，请注意使用场景。</p>

<h2 id="formatter-timestamp-时间戳">Formatter::timestamp 时间戳</h2>

<p>这个函数是对<code>time()</code>的一个及其简单的一个封装。之所以要封装，其实是有一点点说法的。按照微信支付官方开发文档说明，时间戳是自1970年1月1日起的<code>Unix timesamp</code>，即 Epoch timesamp。PHP内置<code>time()</code>函数就是这个值。其他平台，有见到把<code>timesamp</code>翻译成<code>yyyy-MM-dd HH:mm:ss</code>格式的字符串，做这么个封装的原因：</p>

<ol>
<li>对函数返回值做类型签名，严格区分其他平台的翻译；</li>
<li>PHP的命名空间<code>namespace</code>，存在<code>FQN</code>引用，自<code>PHP7</code>开始，在命名空间下可以<code>use function</code>，为让代码通俗易懂，在一个地方引用内置函数，比多次引用要直观；</li>
</ol>

<p>代码块如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Retrieve the current `Unix` timestamp.
</span><span class="sd"> *
</span><span class="sd"> * @return int - Epoch timestamp.
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">timestamp</span><span class="p">()</span><span class="o">:</span> <span class="nx">int</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">time</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p><a href="https://github.com/TheNorthMemory/wechatpay-php/blob/5fb1c64a154cc63bbff730e59c0632c0f6e45043/tests/FormatterTest.php">测试用例</a>如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testTimestamp</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$timestamp</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">timestamp</span><span class="p">();</span>
    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">&#39;/^1[0-9]{9}/&#39;</span><span class="p">;</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsInt</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">);</span>

    <span class="nv">$timestamp</span> <span class="o">=</span> <span class="nx">strval</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertTrue</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">)</span> <span class="o">===</span> <span class="mi">10</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;assertMatchesRegularExpression&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMatchesRegularExpression</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$timestamp</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertRegExp</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$timestamp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>1开头的10位纯数字，记住了，这就是 <code>Unix timestamp</code> 。</p>

<h2 id="formatter-authorization-认证值">Formatter::authorization 认证值</h2>

<p>这个函数，官方文档说的很详细了，但是内涵相当多的知识点，没有明说(哲学：我认为你应该知道所以我不讲了)，这个函数就是其中之一。翻<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Authorization">MDN</a>，引申有说明，<a href="https://tools.ietf.org/html/rfc7235#section-4.2">RFC 7235, section 4.2: Authorization</a>：只要符合规范，厂商可自主实现<code>&lt;type&gt; &lt;credentials&gt;</code>。</p>

<p>微信支付 <code>APIv3</code> 即以 <code>WECHATPAY2-SHA256-RSA2048</code> 声明 <code>type</code> 变量，<code>mchid=&quot;%s&quot;,nonce_str=&quot;%s&quot;,signature=&quot;%s&quot;,timestamp=&quot;%s&quot;,serial_no=&quot;%s&quot;</code> 组合实现 <code>credentials</code> 声明。</p>

<p>代码块如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Formatting for the heading `Authorization` value.
</span><span class="sd"> *
</span><span class="sd"> * @param string $mchid - The merchant ID.
</span><span class="sd"> * @param string $nonce - The Nonce string.
</span><span class="sd"> * @param string $signature - The base64-encoded `Rsa::sign` ciphertext.
</span><span class="sd"> * @param string $timestamp - The `Unix` timestamp.
</span><span class="sd"> * @param string $serial - The serial number of the merchant public certification.
</span><span class="sd"> *
</span><span class="sd"> * @return string - The APIv3 Authorization `header` value
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">authorization</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$mchid</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$signature</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$timestamp</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$serial</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">sprintf</span><span class="p">(</span>
        <span class="s1">&#39;WECHATPAY2-SHA256-RSA2048 mchid=&#34;%s&#34;,nonce_str=&#34;%s&#34;,signature=&#34;%s&#34;,timestamp=&#34;%s&#34;,serial_no=&#34;%s&#34;&#39;</span><span class="p">,</span>
        <span class="nv">$mchid</span><span class="p">,</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">,</span> <span class="nv">$timestamp</span><span class="p">,</span> <span class="nv">$serial</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>那些官方没有明说的知识点就来了：</p>

<ol>
<li>商户号 <code>mchid</code> 是1至32字符的<code>base62</code>字符串，当前绝大部分商户号是纯数字；</li>
<li>请求随机串 <code>nonce_str</code> 只要能通过HTTP上送的字符均可，建议是至少16字符的<code>base62</code>字符串；</li>
<li>签名值 <code>signature</code> 是<code>base64</code>字符串，base64末尾有可能有0个、1个或者2个<code>=</code>号，这都是正常的<code>base64</code>字符串；</li>
<li>时间戳 <code>timestamp</code> 是 <code>unix timestamp</code>，如 <code>Formatter::timestamp()</code> 封装所述;</li>
<li>商户API证书 <code>serial_no</code> 是8至40字符的<code>【0-9A-Z]</code>全大写字符串；</li>
<li>认证值有字典要求，即 <code>mchid,nonce,signature,timestamp,serial</code> 即这5个必须出现，排列组合顺序任意，值的组合用半角逗号(,)分隔，严格没有空格；</li>
</ol>

<p>我们用测试用例覆盖来校验如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testAuthorization</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$value</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">authorization</span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">nonce</span><span class="p">(),</span> <span class="s1">&#39;mock&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">timestamp</span><span class="p">(),</span> <span class="s1">&#39;mockmockmock&#39;</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsString</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertStringStartsWith</span><span class="p">(</span><span class="s1">&#39;WECHATPAY2-SHA256-RSA2048 &#39;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertStringEndsWith</span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>

    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">&#39;/^WECHATPAY2-SHA256-RSA2048 &#39;</span>
        <span class="o">.</span> <span class="s1">&#39;mchid=&#34;[0-9A-Za-z]{1,32}&#34;,&#39;</span>
        <span class="o">.</span> <span class="s1">&#39;nonce_str=&#34;[0-9A-Za-z]{16,}&#34;,&#39;</span>
        <span class="o">.</span> <span class="s1">&#39;signature=&#34;[0-9A-Za-z\+\/]+={0,2}&#34;,&#39;</span>
        <span class="o">.</span> <span class="s1">&#39;timestamp=&#34;1[0-9]{9}&#34;,&#39;</span>
        <span class="o">.</span> <span class="s1">&#39;serial_no=&#34;[0-9A-Z]{8,40}&#34;$/&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;assertMatchesRegularExpression&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMatchesRegularExpression</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertRegExp</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>PS: 官方文档上，特意说了 认证类型 <code>&lt;type&gt;</code>，目前为 <code>WECHATPAY2-SHA256-RSA2048</code>，畅想应该还会有其他值。所以在<code>APIv3</code>开发的时候，建议还是要<strong>多看看官方文档/公告说明</strong>，以免 <code>我的代码没动过啊，为什么现在不行了</code> 这类问题产生。</p>

<h2 id="formatter-request-请求字符串">Formatter::request 请求字符串</h2>

<p>顾名思义，这个函数就是用来格式化请求参数的，按照官方开发文档介绍，输入参数是需要按照&rdquo;\n&rdquo;(char<code>0x0A</code>)做排列合并，而<code>0x0A</code>是个非打印字符，文本描述起来比较困难，另外对于空请求串情况，占位行不能省略，顾做一个纵向封装，以程序语言(函数型参)来描述请求串，代码块如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Formatting this `HTTP::request` for `Rsa::sign` input.
</span><span class="sd"> *
</span><span class="sd"> * @param string $method - The HTTP verb, must be the uppercase sting.
</span><span class="sd"> * @param string $uri - Combined string with `URL::pathname` and `URL::search`.
</span><span class="sd"> * @param string $timestamp - The `Unix` timestamp, should be the one used in `authorization`.
</span><span class="sd"> * @param string $nonce - The `Nonce` string, should be the one used in `authorization`.
</span><span class="sd"> * @param string $body - The playload string, HTTP `GET` should be an empty string.
</span><span class="sd"> *
</span><span class="sd"> * @return string - The content for `Rsa::sign`
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">request</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$method</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$timestamp</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="na">joinedByLineFeed</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$timestamp</span><span class="p">,</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>函数入参接受5部分，其中<code>$body</code>可为空，内置驱动 <code>joinedByLineFeed</code> 做参数合并并返回字符串。这里有个点就是对入参 <code>$timestamp</code> 的类型定义，这里用了字符串定义，原因是：合并后的输出是个字符串，输入端就做了*妥协*，当然在非严格限制模式行，用纯数字输入也是可以的。</p>

<p>测试用例覆盖如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">const</span> <span class="no">LINE_FEED</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">requestPhrasesProvider</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">&#39;DELETE root(/)&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;DELETE root(/) with query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;/?hello=wechatpay&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;GET root(/)&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;GET root(/) with query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/?hello=wechatpay&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;POST root(/) with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;POST root(/) with body and query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/?hello=wechatpay&#39;</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;PUT root(/) with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;PUT root(/) with body and query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;/?hello=wechatpay&#39;</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;PATCH root(/) with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;PATCH root(/) with body and query&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span> <span class="s1">&#39;/?hello=wechatpay&#39;</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd"> * @dataProvider requestPhrasesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testRequest</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$method</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$body</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$value</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">request</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">timestamp</span><span class="p">(),</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">nonce</span><span class="p">(),</span> <span class="nv">$body</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsString</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertStringStartsWith</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertStringEndsWith</span><span class="p">(</span><span class="nx">LINE_FEED</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertLessThanOrEqual</span><span class="p">(</span><span class="nx">substr_count</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nx">LINE_FEED</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>

    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">&#39;#^&#39;</span> <span class="o">.</span> <span class="nv">$method</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span>  <span class="nx">preg_quote</span><span class="p">(</span><span class="nv">$uri</span><span class="p">)</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span> <span class="s1">&#39;1[0-9]{9}&#39;</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span> <span class="s1">&#39;[0-9A-Za-z]{32}&#39;</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span> <span class="nx">preg_quote</span><span class="p">(</span><span class="nv">$body</span><span class="p">)</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span> <span class="s1">&#39;$#&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;assertMatchesRegularExpression&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMatchesRegularExpression</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertRegExp</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>测试用例说明一下，共计十种情形，函数返回值，必须以所请求的 <code>$method</code> 开头，并且至少含有5个<code>LINE_FEED</code>常量，其中一个<code>LINE_FEED</code>在末尾。 用例的数据供给，含了已知的<code>APIv3</code> HTTP verbs，即：<code>DELETE</code>, <code>GET</code>, <code>POST</code>, <code>PUT</code> 及 <code>PATCH</code>。 按照 <a href="https://tools.ietf.org/html/rfc3986">rfc3986</a> 规范，<code>DELETE</code>及<code>GET</code>是不带请求<code>$body</code>的。</p>

<h2 id="formatter-response-响应字符串">Formatter::response 响应字符串</h2>

<p>这个函数是<code>APIv3</code>开发文档上验签逻辑的一个封装，直白代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Formatting this `HTTP::response` for `Rsa::verify` input.
</span><span class="sd"> *
</span><span class="sd"> * @param string $timestamp - The `Unix` timestamp, should be the one from `response::headers[Wechatpay-Timestamp]`.
</span><span class="sd"> * @param string $nonce - The `Nonce` string, should be the one from `response::headers[Wechatpay-Nonce]`.
</span><span class="sd"> * @param string $body - The response payload string, HTTP status(`201`, `204`) should be an empty string.
</span><span class="sd"> *
</span><span class="sd"> * @return string - The content for `Rsa::verify`
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">response</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$timestamp</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="na">joinedByLineFeed</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">,</span> <span class="nv">$nonce</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>测试用例覆盖如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">responsePhrasesProvider</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">&#39;HTTP 200 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 200 STATUS with no body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 202 STATUS with no body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 204 STATUS with no body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 301 STATUS with no body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 301 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 302 STATUS with no body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 302 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 307 STATUS with no body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 307 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 400 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 401 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 403 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 404 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 500 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;{}&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 502 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HTTP 503 STATUS with body&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd"> * @dataProvider responsePhrasesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testResponse</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$body</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$value</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">response</span><span class="p">((</span><span class="nx">string</span><span class="p">)</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">timestamp</span><span class="p">(),</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">nonce</span><span class="p">(),</span> <span class="nv">$body</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsString</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertStringEndsWith</span><span class="p">(</span><span class="nx">LINE_FEED</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertLessThanOrEqual</span><span class="p">(</span><span class="nx">substr_count</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nx">LINE_FEED</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

    <span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">&#39;#^1[0-9]{9}&#39;</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span> <span class="s1">&#39;[0-9A-Za-z]{32}&#39;</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span> <span class="nx">preg_quote</span><span class="p">(</span><span class="nv">$body</span><span class="p">)</span> <span class="o">.</span> <span class="nx">LINE_FEED</span>
        <span class="o">.</span> <span class="s1">&#39;$#&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;assertMatchesRegularExpression&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMatchesRegularExpression</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertRegExp</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>知识点如下：</p>

<ol>
<li>HTTP请求返回内容，均是纯文本格式，即使是头部内容，解析出来也是字符串形式；</li>
<li>与请求串格式化函数很像，这里接受3个参数，并且使用内置抽象函数<code>joinedByLineFeed</code>做数据合并；</li>
<li>官方文档上，仅描述了<code>204</code>状态码时的返回内容为空，其实API接口，也有可能产生<code>202</code>状态码返回，内容也是空的；</li>
<li><code>301/302/307/403/404/502/503</code>等状态码时，返回的内容有可能不是预期的<code>json</code>字符串，而是<code>html</code>串；</li>
<li><code>$timestamp</code>/<code>$nonce</code> 是从HTTP HEADES上取，对应的key是<code>Wechatpay-Timestamp</code>及<code>Wechatpay-Nonce</code>，其实还有3个key非常有用，后边再讲;</li>
</ol>

<h2 id="formatter-joinedbylinefeed-字符合并">Formatter::joinedByLineFeed 字符合并</h2>

<p>上边两个函数，都提到这个字符串合并函数了，之所以单独拎出来，是因为这个函数不仅仅用在这两个函数之上，微信字符与微信的数据交换<code>二次签名</code>以及<code>官方小程序发券</code>插件数据签名，数据格式均以<code>0x0A</code>做合并签名，并且末行的<code>0x0A</code>是不能少的。</p>

<p>这里不得不对<code>APIv3</code>的规范性做个感性评价，一致性还是相当可以的（虽然有难以言表的接口出现，拔特总体还是很可以的）。</p>

<p>代码块如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Joined this inputs by for `Line Feed`(LF) char.
</span><span class="sd"> *
</span><span class="sd"> * @param string[] ...$pieces - The string(s) joined by line feed.
</span><span class="sd"> *
</span><span class="sd"> * @return string - The joined string.
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">joinedByLineFeed</span><span class="p">(</span><span class="o">...</span><span class="nv">$pieces</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">implode</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$pieces</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>这里用到了<code>PHP7</code>的弹性入参功能<code>Variable-length argument lists</code>，入参是平展展的字符串，赋值给<code>$piecies</code>型参，内部用了内置的<code>implode</code>及<code>array_merge</code>函数，来构建末尾是<code>0xoA</code>的字符串。</p>

<p>测试用例如下(其实request/response都已经覆盖)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">joinedByLineFeedPhrasesProvider</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">&#39;one argument&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;two arguments&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
        <span class="s1">&#39;mixed arguments&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="nx">LINE_FEED</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">null</span><span class="nx">，</span> <span class="s1">&#39;4&#39;</span><span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd"> * @dataProvider joinedByLineFeedPhrasesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testJoinedByLineFeed</span><span class="p">(</span><span class="o">...</span><span class="nv">$data</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$value</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">joinedByLineFeed</span><span class="p">(</span><span class="o">...</span><span class="nv">$data</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsString</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertStringEndsWith</span><span class="p">(</span><span class="nx">LINE_FEED</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertLessThanOrEqual</span><span class="p">(</span><span class="nx">substr_count</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nx">LINE_FEED</span><span class="p">),</span> <span class="nx">count</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testNoneArgumentPassedToJoinedByLineFeed</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$value</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">joinedByLineFeed</span><span class="p">();</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsString</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertStringNotContainsString</span><span class="p">(</span><span class="nx">LINE_FEED</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>

    <span class="nx">self</span><span class="o">::</span><span class="na">assertTrue</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p><strong>小技巧：</strong> 在测试用例上，使用了<code>PHP7</code>的变长函数参数特性，透传给了被测试函数（不一定是个好方案），姑且先这样测试，后续再说。</p>

<h2 id="formatter-ksort-字典序排列数组">Formatter::ksort 字典序排列数组</h2>

<p>这个函数是<code>APIv2</code>用的，字典序排序入参，代码块如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Sort an array by key with `SORT_FLAG_CASE | SORT_NATURAL` flag.
</span><span class="sd"> *
</span><span class="sd"> * @param array&lt;string, string|int&gt; $thing - The input array.
</span><span class="sd"> *
</span><span class="sd"> * @return array&lt;string, string|int&gt; - The sorted array.
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">ksort</span><span class="p">(</span><span class="k">array</span> <span class="nv">$thing</span> <span class="o">=</span> <span class="p">[])</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="nx">ksort</span><span class="p">(</span><span class="nv">$thing</span><span class="p">,</span> <span class="nx">SORT_FLAG_CASE</span> <span class="o">|</span> <span class="nx">SORT_NATURAL</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$thing</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p><strong>知识点:</strong> <code>PHP</code> 的 <code>SORT_NATURAL</code> 是按自然序排序，让我们用测试用例来感受一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">ksortByFlagNaturePhrasesProvider</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;rfc1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc822&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc2086&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc822&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc2086&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">],</span>
        <span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd"> * @dataProvider ksortByFlagNaturePhrasesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testKsort</span><span class="p">(</span><span class="k">array</span> <span class="nv">$thing</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$excepted</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertEquals</span><span class="p">(</span><span class="nx">Formatter</span><span class="o">::</span><span class="na">ksort</span><span class="p">(</span><span class="nv">$thing</span><span class="p">),</span> <span class="nv">$excepted</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">nativeKsortPhrasesProvider</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;rfc1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc822&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc2086&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc2086&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;rfc822&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
        <span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd"> * @dataProvider nativeKsortPhrasesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testNativeKsort</span><span class="p">(</span><span class="k">array</span> <span class="nv">$thing</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$excepted</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nx">ksort</span><span class="p">(</span><span class="nv">$thing</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$thing</span><span class="p">,</span> <span class="nv">$excepted</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>差异点就在于，对于字符串+数字序列的键值，自然排序是<code>rfc1, rfc822, rfc2086</code>，默认排序是<code>rfc1, rfc2086, rfc822</code>，理论上，这个和官方的<code>字典序</code>排序是不完全一样的，待后续观察。</p>

<h2 id="formatter-querystringlike-数组转字符串">Formatter::queryStringLike 数组转字符串</h2>

<p>方法名儿已经语义化了，是跟<code>querystring</code>做法类似，但是是有排除，排除规则是：键值是<code>sign</code>的，值是空串或者<code>null</code>的。代码块如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * Like `queryString` does but without the `sign` and `empty value` entities.
</span><span class="sd"> *
</span><span class="sd"> * @param array&lt;string, string|int|null&gt; $thing - The input array.
</span><span class="sd"> *
</span><span class="sd"> * @return string - The `key=value` pair string whose joined by `&amp;` char.
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">queryStringLike</span><span class="p">(</span><span class="k">array</span> <span class="nv">$thing</span> <span class="o">=</span> <span class="p">[])</span><span class="o">:</span> <span class="nx">string</span>
<span class="p">{</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$thing</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$key</span> <span class="o">===</span> <span class="s1">&#39;sign&#39;</span> <span class="o">||</span> <span class="nx">is_null</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>为什么要排除掉<code>null</code>呢？？这其实是本SDK一个强制要求，<code>APIv2</code>上，有一个接口是不太标准的，要求入参是<code>NULL</code>字符串，<code>null</code>数据类型和<code>NULL</code>字符串不是一回事儿，不是一回事儿，不是一回事儿，重要的事情说三遍。。。。</p>

<p>测试用例覆盖如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**
</span><span class="sd"> * @dataProvider nativeKsortPhrasesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testNativeKsort</span><span class="p">(</span><span class="k">array</span> <span class="nv">$thing</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$excepted</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertTrue</span><span class="p">(</span><span class="nx">ksort</span><span class="p">(</span><span class="nv">$thing</span><span class="p">));</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$thing</span><span class="p">,</span> <span class="nv">$excepted</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">queryStringLikePhrasesProvider</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">&#39;none specific chars&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
            <span class="s1">&#39;a=1&amp;b=3&amp;aa=2&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;has `sign` key&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;sign&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
            <span class="s1">&#39;a=1&amp;b=3&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;has `empty` value&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
            <span class="s1">&#39;a=1&amp;b=3&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;has `null` value&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">],</span>
            <span class="s1">&#39;a=1&amp;c=2&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;mixed `sign` key, `empty` and `null` values&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;bob&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;alice&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span> <span class="s1">&#39;tom&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;sign&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;mock&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bob=1&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd"> * @dataProvider queryStringLikePhrasesProvider
</span><span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">testQueryStringLike</span><span class="p">(</span><span class="k">array</span> <span class="nv">$thing</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$excepted</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nv">$value</span> <span class="o">=</span> <span class="nx">Formatter</span><span class="o">::</span><span class="na">queryStringLike</span><span class="p">(</span><span class="nv">$thing</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertIsString</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$excepted</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>至此，SDK上封装的基础格式化参数函数讲解完了，知识点即“踩坑”点，规集整理出来，分享给大家。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">James</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-06-29
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        
        <a class="next" href="/post/18-points-of-the-wechatpay-php-openapi-sdk-catelog/">
            <span class="next-text nav-default">微信支付PHP开发对接18讲——从起步到跑顺路</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  
  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://github.com/TheNorthMemory/" class="iconfont icon-github" title="github"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">James</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-125471285-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
